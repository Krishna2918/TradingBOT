"""
Autonomous Trading AI - FULL INTEGRATION
No placeholders, no simulations - REAL AI trading with ALL features

Integrates:
- Comprehensive Data Pipeline (TSX/TSXV, Options, Macro, News, Sentiment)
- LSTM/GRU/Transformer Models
- RL Agents (PPO/DQN)
- Event Awareness (Calendar, Volatility, Anomalies)
- AI Ensemble (Grok, Kimi, Claude)
- Risk Management
- Execution Engine
- Learning & Self-Improvement
"""

import logging
import numpy as np
import pandas as pd
from typing import Dict, List, Optional, Tuple
from datetime import datetime, timedelta
import json
from pathlib import Path

# Import AI Activity Logger
from src.logging.ai_activity_logger import (
    ai_logger, log_ai_signal, log_ai_trade, log_ai_decision, 
    log_ai_activity, get_ai_activity_summary
)

# Import ALL system components
from src.data_pipeline.comprehensive_data_pipeline import ComprehensiveDataPipeline
from src.ai.model_stack.lstm_model import LSTMPredictor
from src.ai.model_stack.gru_transformer_model import GRUTransformerPredictor
from src.ai.model_stack.meta_ensemble import MetaEnsemble
from src.ai.rl.ppo_agent import PPOTradingAgent
from src.ai.rl.dqn_agent import DQNTradingAgent
from src.ai.chatgpt_integration import ChatGPTIntegration
from src.ai.hybrid_control_plane import HybridControlPlane
from src.ai.meta_ensemble_blender import MetaEnsembleBlender
from src.ai.local_reasoner import LocalReasoner
from src.ai.autonomous_trading_ai_helpers import (
    convert_analysis_to_predictions,
    calculate_daily_pnl,
    calculate_max_drawdown_5d,
    calculate_volatility_zscore,
    calculate_ensemble_accuracy,
    calculate_sharpe_ratio
)
from src.event_awareness.event_calendar import EventCalendar
from src.event_awareness.volatility_detector import VolatilityDetector
from src.event_awareness.anomaly_detector import AnomalyDetector
from src.risk_management.capital_architecture import CapitalArchitectureManager
from src.execution.execution_engine import ExecutionEngine, OrderType, OrderSide
from src.penny_stocks.penny_stock_detector import PennyStockDetector
from src.sip.sip_simulator import SIPSimulator
from src.trading_modes.mode_manager import ModeManager
from src.reporting.report_generator import ReportGenerator

logger = logging.getLogger(__name__)

class AutonomousTradingAI:
    """
    Fully autonomous AI trader - makes ALL decisions
    
    Features:
    - Real-time market data (Yahoo Finance)
    - News sentiment analysis
    - Macro economic indicators
    - Options flow analysis
    - AI model predictions (LSTM/GRU/Transformer)
    - Reinforcement learning (PPO/DQN)
    - Event-driven trading
    - Self-learning from mistakes
    - Auto capital management
    - Fractional shares support
    """
    
    def __init__(
        self,
        mode: str = 'demo',
        initial_capital: float = 100.0,
        symbols: List[str] = None
    ):
        """Initialize the autonomous AI"""
        
        logger.info("="*80)
        logger.info("AUTONOMOUS TRADING AI - INITIALIZING")
        logger.info("="*80)
        
        self.mode = mode
        self.initial_capital = initial_capital
        self.current_capital = initial_capital
        self.symbols = symbols or self._get_default_symbols()
        
        # Trading state
        self.holdings = {}  # {symbol: {'shares': float, 'avg_price': float, 'current_price': float}}
        self.trades = []
        self.decisions_log = []
        self.performance_history = []
        
        # Learning state
        self.mistakes_log = []
        self.successful_patterns = []
        self.market_regimes = []
        
        # Initialize ALL components
        logger.info("Initializing Data Pipeline...")
        try:
            self.data_pipeline = ComprehensiveDataPipeline()
        except Exception as e:
            logger.warning(f"âš ï¸ Data pipeline init failed: {e}, using fallback")
            self.data_pipeline = None
        
        logger.info("Initializing AI Models...")
        try:
            self.lstm_predictor = LSTMPredictor()
            self.gru_predictor = GRUTransformerPredictor()
            self.meta_ensemble = MetaEnsemble()
        except Exception as e:
            logger.warning(f"âš ï¸ AI models init failed: {e}")
            self.lstm_predictor = None
            self.gru_predictor = None
            self.meta_ensemble = None
        
        logger.info("Initializing RL Agents...")
        try:
            self.ppo_agent = PPOTradingAgent()
            self.dqn_agent = DQNTradingAgent()
        except Exception as e:
            logger.warning(f"âš ï¸ RL agents init failed: {e}")
            self.ppo_agent = None
            self.dqn_agent = None
        
        logger.info("Initializing ChatGPT Integration...")
        try:
            # Get API key from data pipeline config
            api_key = None
            if self.data_pipeline and hasattr(self.data_pipeline, 'config'):
                api_key = self.data_pipeline.config.get('api_keys', {}).get('openai_api_key')
            
            if api_key and api_key != 'demo':
                self.chatgpt = ChatGPTIntegration(api_key, self.data_pipeline.config)
                logger.info("ChatGPT integration initialized")
            else:
                logger.warning("ChatGPT API key not configured")
                self.chatgpt = None
        except Exception as e:
            logger.warning(f"âš ï¸ ChatGPT integration init failed: {e}")
            self.chatgpt = None
        
        logger.info("Initializing Hybrid Control Plane...")
        try:
            # Initialize hybrid control plane
            control_config = {'gpt5_api_key': 'test-key'}
            self.hybrid_control = HybridControlPlane(control_config)
            
            # Initialize meta-ensemble blender
            self.meta_blender = MetaEnsembleBlender(control_config)
            
            # Initialize local reasoner
            self.local_reasoner = LocalReasoner(control_config)
            
            # Connect local reasoner to hybrid control
            self.hybrid_control.local_reasoner = self.local_reasoner
            
            logger.info("Hybrid Control Plane initialized successfully")
        except Exception as e:
            logger.warning(f"âš ï¸ Hybrid Control Plane init failed: {e}")
            self.hybrid_control = None
            self.meta_blender = None
            self.local_reasoner = None
        
        logger.info("Initializing Event Awareness...")
        try:
            self.event_calendar = EventCalendar()
            self.volatility_detector = VolatilityDetector()
            self.anomaly_detector = AnomalyDetector()
        except Exception as e:
            logger.warning(f"âš ï¸ Event awareness init failed: {e}")
            self.event_calendar = None
            self.volatility_detector = None
            self.anomaly_detector = None
        
        logger.info("Initializing Capital Management...")
        try:
            self.capital_allocator = CapitalArchitectureManager()
        except Exception as e:
            logger.warning(f"âš ï¸ Capital allocator init failed: {e}")
            self.capital_allocator = None
        
        logger.info("Initializing Penny Stock Detector...")
        try:
            self.penny_detector = PennyStockDetector()
        except Exception as e:
            logger.warning(f"âš ï¸ Penny detector init failed: {e}")
            self.penny_detector = None
        
        logger.info("Initializing SIP Simulator...")
        try:
            self.sip_simulator = SIPSimulator()
        except Exception as e:
            logger.warning(f"âš ï¸ SIP simulator init failed: {e}")
            self.sip_simulator = None
        
        logger.info("Initializing Report Generator...")
        try:
            self.report_generator = ReportGenerator()
        except Exception as e:
            logger.warning(f"Report generator init failed: {e}")
            self.report_generator = None
        
        # Initialize Regime Detection
        logger.info("Initializing Regime Detection...")
        try:
            from src.ai.regime_detection import RegimeManager
            self.regime_manager = RegimeManager(self.config)
            logger.info("Regime detection initialized")
        except Exception as e:
            logger.warning(f"Regime detection init failed: {e}")
            self.regime_manager = None
        
        # Initialize Feature Conflict Checker
        logger.info("Initializing Feature Conflict Checker...")
        try:
            from src.ai.feature_conflict_checker import FeatureManager
            self.feature_manager = FeatureManager(self.config)
            logger.info("Feature conflict checker initialized")
        except Exception as e:
            logger.warning(f"Feature conflict checker init failed: {e}")
            self.feature_manager = None
        
        # Initialize Dynamic Reward Mix
        logger.info("Initializing Dynamic Reward Mix...")
        try:
            from src.ai.dynamic_reward_mix import RewardMixManager
            self.reward_mix_manager = RewardMixManager(self.config)
            logger.info("Dynamic reward mix initialized")
        except Exception as e:
            logger.warning(f"Dynamic reward mix init failed: {e}")
            self.reward_mix_manager = None
        
        # Initialize Policy Versioning
        logger.info("Initializing Policy Versioning...")
        try:
            from src.ai.policy_versioning import PolicyVersionManager
            self.policy_version_manager = PolicyVersionManager(self.config)
            logger.info("Policy versioning initialized")
        except Exception as e:
            logger.warning(f"Policy versioning init failed: {e}")
            self.policy_version_manager = None
        
        logger.info("Autonomous AI Initialized!")
        logger.info(f"Mode: {mode.upper()}")
        logger.info(f"Capital: ${initial_capital:,.2f}")
        logger.info(f"Symbols: {len(self.symbols)}")
        logger.info("="*80)
    
    def _get_default_symbols(self) -> List[str]:
        """Get default TSX symbols"""
        return [
            'RY.TO', 'TD.TO', 'BNS.TO', 'BMO.TO', 'SHOP.TO',
            'CNQ.TO', 'ENB.TO', 'CP.TO', 'CNR.TO', 'SU.TO'
        ]
    
    def analyze_market(self) -> Dict:
        """
        Comprehensive market analysis using ALL data sources
        
        Returns complete market intelligence
        """
        logger.info("Analyzing Market...")
        log_ai_activity('market_analysis', 'Starting comprehensive market analysis', {
            'symbols_count': len(self.symbols),
            'symbols': self.symbols[:5]  # Log first 5 symbols
        })
        
        analysis = {
            'timestamp': datetime.now(),
            'market_data': {},
            'technical_indicators': {},
            'sentiment': {},
            'macro_indicators': {},
            'options_flow': {},
            'events': {},
            'volatility': {},
            'anomalies': {},
            'ai_predictions': {},
            'regime': None
        }
        
        # 1. Fetch real-time market data
        if self.data_pipeline:
            try:
                logger.info("  ðŸ“Š Fetching market data...")
                market_data = self.data_pipeline.fetch_tsx_data(self.symbols, "1m")
                analysis['market_data'] = market_data
                
                logger.info("  ðŸ“° Fetching news sentiment...")
                sentiment = self.data_pipeline.fetch_news_sentiment(self.symbols)
                analysis['sentiment'] = sentiment
